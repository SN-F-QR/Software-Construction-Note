# 项目构建

## 结构

课程前端为 React+JS, 后端则使用 express.js, 使用 Node.js 运行 JS 脚本. 因此库的管理都由 Node 的 package.json 进行.

具体项目结构如下:

- /client 包括所有 React 代码, 组件/页面/utilities 等前端
- /server 包括后端代码
- 其它

## API 端口建立

在 server.js 中使用如下代码即可构建一个相应 GET 请求的 API(实际是一个 route handler)

```js
const app = express();
app.get("/api/test", (req, res) => {
  res.send({ message: "My first API" });
});
```

其中, get 对应 GET 请求, 第一个参数为 API 端口, 第二个参数为对应操作(handler), 其中 req 为请求, res 为返回结果

对端口的定义, 需要从最具体到最广泛, 比如先定义`"/api/test"->"/api/*"`.

### Middleware(中间件)

Middleware(中间件)是一个处理 HTTP 请求/响应的软件层，具有以下特点：

- 位于客户端请求和服务器响应之间(即接受 req 和发送 res 之间)
- 可以检查、修改或拦截 HTTP 请求和响应
- 按照特定顺序串联执行,形成处理管道(依靠 next()传递 REQUEST)
- Route handlers 在中间件的最后面(但也属于中间件)

<img src="../images/middleware.png" width=100%/>

在 Express 中使用 app.use()注册中间件, 比如`app.use(express.json())`.

也可以自定义中间件处理函数, 其中路径为 optional:

```js
const app = express();
app.use("/time", (req, res, next) => {
  console.log("Time:", Date.now());
  next();
});

app.use((error, req, res, next) => {
  // ...
});
```

next 为调用下一个中间件, 如果空缺则调用默认的下一个. error middlewares 为错误处理用, 定义在所有中间件的**最后**.

### Catch All 端口

用于返回 HTML 和其它 React 相关的文件来提供前端的构建.

```js
const express = require("express");
const path = require("path"); // utilizes for Handling path

const app = express();
const reactPath = path.resolve(__dirname, "..", "client", "dist"); // path for react files
app.use(express.static(reactPath)); // 将指定目录下的文件直接提供给客户端访问

app.get("*", (req, res) => {
  res.sendFile(path.join(reactPath, "index.html")); // 只需返回index作为入口, react代码会解决URL路由
});
```

### API 的组织分类

后端会定义非常多的端口, 端口可以用他们的 API 路由进行区分, 如`"/cat", "/dog"`. 为了分类的清晰, 不要把所有端口都放在 app 内(即 server.js, main- application), 而是利用 router(分组的 API 端口, mini-application).

```text
src/
  ├── routes/
  │   ├── userRoutes.js
  │   ├── productRoutes.js
  │   └── orderRoutes.js
  └── app.js
```

分类后, 在 app 和路由的 js 中分别实现:

```js
// userRoutes.js
const express = require("express");
const router = express.Router();
// ...define middlers and handlers
modules.exports = router;

// app.js
const express = require("express");
const app = express();
const userRoutes = require("./userRoutes");
app.use("/api", userRoutes); // 注意api route, 这里是api, 而userRoutes中不需要接api, 两者组合为总的api route
```

### 请求的处理

对于请求, 需要区分 GET/POST, 两者的参数有区别:

- GET 的参数在 query 中, 使用 req.query.xxx 访问
- POST 参数在 body 中, 使用 req.body.xxx 访问
